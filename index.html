<!DOCTYPE html>

<html>
<head>
  <meta http-equiv="CONTENT-TYPE" content="text/html; charset=UTF-8">
  <link rel="stylesheet" href="styles/style.css"/>
  <title>D&D</title>
  <style>
  
.character {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 1fr;
  gap: 12px;
  width: 934px;
  border: 2px solid #8c0000;
  padding: 12px;
  background: #111;
}
.unit-btn {
  text-align: center;
  color: white;
  background: #818589;
  border-bottom: 2px solid #E5E4E2;
  width: 100%;
  padding: 10px;
}
.char {
  width: 100%;
  height: 100%;
  border: 2px solid #E5E4E2;
  color: white;
}
.abilities, .passives {
  border: 2px solid #848884;
}
.index {
  display: flex;
  width: 934px;
  border: 2px solid #8c0000;
  color: white;
  background: black;
}
.tab-btn, .enemy-btn {
    padding: 20px 40px;
    border: none;
    cursor: pointer;
    background: #353935;
    color: white;
}
.tab-btn.active {
    border-bottom: 3px solid black;
    color: gold;
}
.tab-content {
    display: none;
    padding: 20px;
    background: #111;
    color: white;
}
.tab-content.active {
    display: block;
}
#start-btn {
  font-weight: bold;
  position: absolute;
  background: #353935;
  color: white;
  left: 40%;
}

#battle {
  background-image: url('https://limbuscompany.wiki.gg/images/Der_Fluchsch%C3%BCtze_BG_2.png?5b1b93=&format=original');
  background-position: center;
  background-attachment: fixed;
  background-size: cover;
  color: white;
  height: 96vh;
}
#combatLog {
  width: 70%;
  height: 200px;
  margin: 20px auto;
  background: #111;
  padding: 10px;
  border-radius: 10px;
  overflow-y: auto;
  font-size: 14px;
  border: 1px solid #444;
  opacity: 0.8;
}
#battleinfo {
  display: flex;
  justify-content: space-between;
  padding: 30px;
}
.side {
  width: 45%;
  text-align: center;
}
.hp-bar {
    width: 100%;
    height: 20px;
    background: #444;
    border: 2px solid #000;
    border-radius: 4px;
    margin-bottom: 5px;
}
.hp-fill {
    height: 100%;
    background: red;
    width: 100%;
    transition: width 0.3s;
}
.hp-text {
    color: white;
    font-weight: bold;
}
.end-screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(20, 20, 20, 0.85);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    font-size: 40px;
    z-index: 999;
}

#return-btn-victory, #return-btn-defeat {
    padding: 10px 25px;
    font-size: 20px;
    margin-top: 20px;
}
  </style>
</head>
<body>
  <div id="prep">
  <div class="preparation">
      <div class="row">
        <div class="tabs">
          <button class="tab-btn active" data-tab="character">Character</button>
          <button class="tab-btn active" data-tab="index">Index</button>
        </div>
        <div class="tab-content active" id="character">
          <div class="character">
          <div class="char">
            <p style="class=font-size: 20px; font-weight: bold;"><p style="text-align: center;"> Sonelia <br>Class : Guard<img src="https://arknights.wiki.gg/images/Guard.png?339f06" width="25"></p></p>
              <br> HP : Moderate <br>ATK : Moderate<br>DEF : Normal</p>
            <div class="abilities">
              <p style="font-weight: bold; font-size: 24px;">Abilities</p>
              <div class="skill1"><p style="font-size: 16px;">1. Slash<br>Effect : Slash the enemy, dealing damage and inflict <img src="https://limbuscompany.wiki.gg/images/thumb/Bleed.png/25px-Bleed.png?cb52f6" width="18">Bleed to them (for 1 turn, stackables)</p></div>
              <div class="skill2"><p style="font-size: 16px;">2. Point-Blank Slash<br><p style="color: red">[Automatically being used on Stunned target after attacking]</p><br>Effect : This attack ignore enemy DEF, Slash the enemy dealing damage and inflict <img src="https://limbuscompany.wiki.gg/images/thumb/Bleed.png/25px-Bleed.png?cb52f6" width="18">Bleed to them (for 1 turn, stackables).<br>Then, trigger all Bleed damage on target and remove its from them.</p></div>
              <div class="skill3-1"><p style="font-size: 16px;">3-1. Block<br>Effect : Reduce damage taken by the next attack, gain Shield equal to Lost HP</p></div>
              <div class="skill3-2"><p style="font-size: 16px;">3-2. Counter<br>Effect : Reduce damage taken by the next attack, gain Shield equal to Lost HP<br>After taken hit, return with an attack deal damage and inflict 1 <img src="https://limbuscompany.wiki.gg/images/thumb/Bleed.png/25px-Bleed.png?cb52f6" width="18">Bleed on them (for 1 turn, stackables)</p></div>
            </div>
            <div class="passives">
              <p style="font-weight: bold; font-size: 24px;">Passives</p>
              <div class="passive1"><p style="font-size: 16px;">1. Fragile Wound<br>Effect : When attacking an enemy affected with <img src="https://limbuscompany.wiki.gg/images/thumb/Bleed.png/25px-Bleed.png?cb52f6" width="18">Bleed, has 10% chances to <img src="https://limbuscompany.wiki.gg/images/thumb/Tremor_Burst.png/25px-Tremor_Burst.png?7613b5" width="18">Stun target (each <img src="https://limbuscompany.wiki.gg/images/thumb/Bleed.png/25px-Bleed.png?cb52f6" width="18">Bleed on target additionally increases chances to procs. by 10%, up to 50%)</p></div>
              <div class="passive2"><p style="font-size: 16px;">2. Take it Back!<br>Effect : While there are an enemy with 2+ <img src="https://limbuscompany.wiki.gg/images/thumb/Bleed.png/25px-Bleed.png?cb52f6" width="18">Bleed stacks, replace 'Block' with 'Counter' instead</p></div>
              <div class="passive3"><p style="font-size: 16px;">3. Open Wound<br>Effect : This unit inflict +1 <img src="https://limbuscompany.wiki.gg/images/thumb/Bleed.png/25px-Bleed.png?cb52f6" width="18">Bleed if target is Stunned, if said enemy has 5+ <img src="https://limbuscompany.wiki.gg/images/thumb/Bleed.png/25px-Bleed.png?cb52f6" width="18">Bleed inflict an addition <img src="https://limbuscompany.wiki.gg/images/thumb/Bleed.png/25px-Bleed.png?cb52f6" width="18">Bleed</p></div>
              <div class="passive4"><p style="font-size: 16px;">4. Overtaken<br>Effect : When this unit using Skill 2, gain 10 <img src="https://limbuscompany.wiki.gg/images/thumb/Offense_Level_Up.png/25px-Offense_Level_Up.png?fd7617" width="18">ATK Up next turn and inflict +1 <img src="https://limbuscompany.wiki.gg/images/thumb/Bleed.png/25px-Bleed.png?cb52f6" width="18">Bleed if target has 50% or less HP</p></div>
            </div>
            <button class="unit-btn" data-id="char_1">Select This Unit</button>
          </div>
          <div class="char">
            <p style="class=font-size: 20px; font-weight: bold;"><p style="text-align: center;"> Gilbert <br> Class : Defender<img src="https://arknights.wiki.gg/images/Defender.png?86409b=&format=original" width="25"></p>
              <br> HP : High <br>ATK : Low <br>DEF : Moderate</p>
            <div class="abilities">
              <p style="font-weight: bold; font-size: 24px">Abilities</p>
              <div class="skill1"><p style="font-size: 16px;">1. Shield Bash<br>Effect : Take less damage in this turn, Charge into target with the Shield dealing damage and inflict <img src="https://limbuscompany.wiki.gg/images/thumb/Load.png/25px-Load.png?daa75a" width="18">Shock to them</p></div>
              <div class="skill2-1"><p style="font-size: 16px;">2-1. Ward<br><p style="color: red;">[Only useable on target with 3+ Shock stacks]</p><br>Effect : Take less damage in this turn, Slash the target dealing damage, deal more damage based on <img src="https://limbuscompany.wiki.gg/images/thumb/Load.png/25px-Load.png?daa75a" width="18">Shock on target and <img src="https://limbuscompany.wiki.gg/images/thumb/Defense_Level_Up.png/25px-Defense_Level_Up.png?89f919" width="18">Defense Up on self.<br>Remove all <img src="https://limbuscompany.wiki.gg/images/thumb/Load.png/25px-Load.png?daa75a" width="18">Shock on target and gain <img src="https://limbuscompany.wiki.gg/images/thumb/Defense_Level_Up.png/25px-Defense_Level_Up.png?89f919" width="18">Defense Up next turn equal to removed Shock</p></div>
              <div class="skill2-2"><p style="font-size: 16px;">2-2. Despair, Crushader<p style="color: red;">[Replace with 'Ward' when there an enemy with 5+ Shock stacks]</p><br>Effect : Take less damage in this turn, Slash the target dealing damage, deal more damage based on <img src="https://limbuscompany.wiki.gg/images/thumb/Load.png/25px-Load.png?daa75a" width="18">Shock on target and <img src="https://limbuscompany.wiki.gg/images/thumb/Defense_Level_Up.png/25px-Defense_Level_Up.png?89f919" width="18">Defense Up on self.<br>Remove all <img src="https://limbuscompany.wiki.gg/images/thumb/Load.png/25px-Load.png?daa75a" width="18">Shock on target, dealing damage based on removed <img src="https://limbuscompany.wiki.gg/images/thumb/Load.png/25px-Load.png?daa75a" width="18">Shock on target</p></div>
              <div class="skill3"><p style="font-size: 16px;">3. Counter<br>Effect : After getting hit, return with an attacks deal damage and inflict 3 <img src="https://limbuscompany.wiki.gg/images/thumb/Load.png/25px-Load.png?daa75a" width="18">Shock</p></div>
            </div>
            <div class="passives">
              <p style="font-weight: bold; font-size: 24px;">Passives</p>
              <div class="passive1"><p style="font-size: 16px;">1. Terror Shock<br>Effect : On Hit again enemy with 3+ <img src="https://limbuscompany.wiki.gg/images/thumb/Load.png/25px-Load.png?daa75a" width="18">Shock, has 15% chances to <img src="https://limbuscompany.wiki.gg/images/thumb/Tremor_Burst.png/25px-Tremor_Burst.png?7613b5" width="18">Stun target, if target has 5+ <img src="https://limbuscompany.wiki.gg/images/thumb/Load.png/25px-Load.png?daa75a" width="18">Shock increase <img src="https://limbuscompany.wiki.gg/images/thumb/Tremor_Burst.png/25px-Tremor_Burst.png?7613b5" width="18">Stun chances to 40%</p></div>
              <div class="passive2"><p style="font-size: 16px;">2. Defensive Stance<br>Effect : When having 5+ <img src="https://limbuscompany.wiki.gg/images/thumb/Defense_Level_Up.png/25px-Defense_Level_Up.png?89f919" width="18">Defense Up, enter <img src="https://limbuscompany.wiki.gg/images/thumb/Defensive_Stance.png/25px-Defensive_Stance.png?90e2d4" width="18">Defensive Stance. While in <img src="https://limbuscompany.wiki.gg/images/thumb/Defensive_Stance.png/25px-Defensive_Stance.png?90e2d4" width="18">Defensive Stance, this unit take less damage but deal less damage</p></div>
            </div>
            <button class="unit-btn" data-id="char_2">Select This Unit</button>
          </div>
        </div>
      </div>
  </div>
  <div class="tab-content active" id="index">
    <div class="index">
      <div class="Base Status"><p style="font-size: 16px;">• Statuses :<br><img src="https://limbuscompany.wiki.gg/images/thumb/Bleed.png/25px-Bleed.png?cb52f6" width="18">Bleed : Every actions affected units has occured, deal (1.5 x Stacks) fixed damage to them.
        <br><img src="https://limbuscompany.wiki.gg/images/thumb/Tremor_Burst.png/25px-Tremor_Burst.png?7613b5" width="18">Stun : Affected units can't acts for this turn, also take 12% more damage.<br><img src="https://limbuscompany.wiki.gg/images/thumb/Load.png/25px-Load.png?daa75a" width="18">Shock : Affected units take 0.5% more damage for every stacks (max 10%)
        <br><img src="https://limbuscompany.wiki.gg/images/thumb/Defense_Level_Up.png/25px-Defense_Level_Up.png?89f919" width="18">Defense Up : Increases DEF by (Stacks) (max 20 stacks)<br><img src="https://limbuscompany.wiki.gg/images/thumb/Defensive_Stance.png/25px-Defensive_Stance.png?90e2d4" width="18">Defense Stance : Take 50% less damage but deal 30% less damage, inflict +1 negative effects with this unit skill effects.
        <br><img src="https://limbuscompany.wiki.gg/images/thumb/Burn.png/25px-Burn.png?bfbea6" width="18">Burn : At the end of the turn, affected units take (2 x Stacks) fixed damage. Then this effects expires.<br><img src="https://limbuscompany.wiki.gg/images/thumb/Cold.png/25px-Cold.png?f24881" width="18">Cold : Decrease RES by 1% for each (Stacks). Turn End : At 10+ <img src="https://limbuscompany.wiki.gg/images/thumb/Cold.png/25px-Cold.png?f24881" width="18">Cold, convert <img src="https://limbuscompany.wiki.gg/images/thumb/Cold.png/25px-Cold.png?f24881" width="18">Cold to <img src="https://limbuscompany.wiki.gg/images/thumb/Frozen.png/25px-Frozen.png?e0b56d" width="18">Frozen.
        <br><img src="https://limbuscompany.wiki.gg/images/thumb/Frozen.png/25px-Frozen.png?e0b56d" width="18">Frozen : Affected units can't acts for this turn, decrease RES by 20%. Can't gain <img src="https://limbuscompany.wiki.gg/images/thumb/Cold.png/25px-Cold.png?f24881" width="18">Cold while this effects present.<br><img src="https://limbuscompany.wiki.gg/images/thumb/Poison.png/25px-Poison.png?89f617" width="18">Poison : At the end of the turn, take (Stacks) fixed damage. Then halved the Stacks.
      </p></div>
    </div>
  </div>
    <button id="start-btn"><p style="font-size: 30px;">Start Battle!</p></button>
  </div>
  </div>
<div id="battle" style="display: none;">
  <div id="battleinfo">
    <div class="side">
      <div id="player-name" style="color: white; font-size: 24px;"></div>
      <div class="hp-bar">
        <div id="player-hp-fill" class="hp-fill"></div>
        <div id="player-hp-text" class="hp-text"></div>
      </div>
    </div>
    <div class="side">
      <div id="enemy-name" style="color: white; font-size: 24px;"></div>
      <div class="hp-bar">
        <div id="enemy-hp-fill" class="hp-fill"></div>
        <div id="enemy-hp-text" class="hp-text"></div>
      </div>
    </div>
  </div>
  <!-- Victory Screen -->
<div id="victory-screen" style="display:none;" class="end-screen">
    <h1>Victory!</h1>
    <button id="return-btn-victory">Return</button>
</div>

<!-- Defeat Screen -->
<div id="defeat-screen" style="display:none;" class="end-screen">
    <h1>Defeat...</h1>
    <button id="return-btn-defeat">Return</button>
</div>
  <div id="combatLog"></div>
  <div id="hand"></div>
</div>
<script>
/* ============================================================
   DOM HELPERS
============================================================ */
const $ = id => document.getElementById(id);
const qAll = sel => Array.from(document.querySelectorAll(sel));

function log(text) {
    const box = $("combatLog");
    if (box) {
        box.innerHTML += text + "<br>";
        box.scrollTop = box.scrollHeight;
    }
}

/* ============================================================
   TABS (giữ nguyên layout cũ)
============================================================ */
const tabs = document.querySelectorAll(".tab-btn");
const contents = document.querySelectorAll(".tab-content");

tabs.forEach(btn => {
    btn.addEventListener("click", () => {
        tabs.forEach(b => b.classList.remove("active"));
        contents.forEach(c => c.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(btn.dataset.tab).classList.add("active");
    });
});

window.onload = () => {
    const first = document.querySelector(".tab-btn");
    if (first) first.click();
};

/* ============================================================
   CHARACTERS
============================================================ */
const characterData = {
    char_1: {
        id: "char_1",
        name: "Sonelia",
        maxHP: 53,
        atk: 28,
        def: 16,
        status: { Bleed: 0, Shock: 0, Stun: 0, DefenseUp: 0, ATKUp: 0 },
        shield: 0,
        passive: {
            guardShieldPercent: 0.30,
            counterDamageScale: 0.6,
            counterBleed: 1,

            fragileMax: 50,
            fragileBase: 10,
            fragilePerBleed: 10,

            overtakenATKUp: 10,
        },
        skills: {
            skill1: {
                id: "skill1",
                name: "Slash",
                damage: 9,
                effects: [{ type: "Bleed", value: 1 }]
            },
            skill2: {
                id: "skill2",
                name: "Point-Blank Slash",
                damage: 24,
                effects: [
                    { type: "Bleed", value: 1 },
                    { type: "triggerBleedThenRemove" }
                ]
            },
            skill3: {
                id: "skill3",
                name: "Guard",
                damage: 0,
                effects: []
            }
        }
    },

    char_2: {
        id: "char_2",
        name: "Gilbert",
        maxHP: 63,
        atk: 10,
        def: 20,
        status: { Bleed: 0, Shock: 0, Stun: 0, DefenseUp: 0, ATKUp: 0 },
        shield: 0,
        passive: {
            terrorShockLow: 0.15,
            terrorShockHigh: 0.40,
            defenseStanceThreshold: 5,
            defenseTakenMult: 0.5,
            defenseDealMult: 0.7
        },
        skills: {
            skill1: {
                id: "skill1",
                name: "Shield Bash",
                damage: 6,
                effects: [{ type: "Shock", value: 1 }]
            },
            skill2: {
                id: "skill2",
                name: "Ward",
                damage: 10,
                effects: [{ type: "ConsumeShockToDefense" }]
            },
            skill2_alt: {
                id: "skill2_alt",
                name: "Despair, Crushader",
                damage: 14,
                effects: [{ type: "ConsumeShockToDamage" }]
            },
            skill3: {
                id: "skill3",
                name: "Counter",
                damage: 7,
                effects: [{ type: "Shock", value: 3 }]
            }
        }
    }
};

/* ============================================================
   ENEMIES
============================================================ */
const enemies = {
    enemy_1: {
        id: "enemy_1",
        name: "Sharp Hooligan",
        maxHP: 54,
        atk: 9,
        def: 6,
        status: { Bleed: 0, Shock: 0, Stun: 0, DefenseUp: 0, Burn: 0 },
        skills: {
            s1: { name: "Rusty Slash", damage: 4, effects: [{type: "Bleed", value: 1}] },
            s2: { name: "Bite", damage: 6, effects: [{type: "Bleed", value: 1}] }
        }
    },
    enemy_2: {
        id: "enemy_2",
        name: "Fiery Veteran",
        maxHP: 57,
        atk: 12,
        def: 10,
        status: { Bleed: 0, Shock: 0, Stun: 0, DefenseUp: 0, Burn: 0 },
        skills: {
            s1: { name: "Flame Jab", damage: 7, effects: [{type: "Burn", value: 1}] },
            s2: { name: "Heavy Strike", damage: 9, effects: [{type: "Shock", value: 1}] }
        }
    },
    enemy_3: {
        id: "enemy_3",
        name: "Sawblade Bot",
        maxHP: 85,
        atk: 8,
        def: 7,
        status: { Bleed: 0, Shock: 0, Stun: 0, DefenseUp: 0, Burn: 0 },
        skills: {
            s1: { name: "Spinning Blade", damage: 8, effects: [{type: "Bleed", value: 1}] },
            s2: { name: "Metal Charge", damage: 5, effects: [{type: "Bleed", value: 2}]}
        }
    },
    enemy_4: { 
        id:"enemy_4", 
        name:"Wei", 
        maxHP:299, 
        atk:22, 
        def:12, 
        status:{Bleed:0,Shock:0,Stun:0,DefenseUp:0,Burn:0}, 
        skills:{
            s1:{name:"Ironsteed Trample",damage:5, effects:[{type: "Bleed", value: 1}]}, 
            s2:{name:"Line-Crushing Calvary Charge",damage:6, effects:[{type: "Bleed", value: 2},{type: "Shock", value: 3}]},
            s3:{name:"Mad Steed's Voidrender", damage: 8, effects:[{type: "Shock", value: 5},{type: "Bleed", value: 2}]}
        }
    },
    enemy_5: {
        id: "enemy_5",
        name: "Distorting Bamboo-hatted Kim",
        maxHP: 137,
        atk: 2,
        def: 16,
        status:{Bleed:0,Shock:0,Stun:0,DefenseUp:0,Burn:0},
        skills: {
            s1: {name: "Draw of the Sword", damage: 6, effects:[{type: "Bleed", value: 1}]},
            s2: {name: "Overthrown", damage: 10, effects:[{type: "Bleed", value: 2}]},
            s3: {name: "To Claim Their Bones", damage: 20, effects:[{type: "Bleed", value: 3}]}
        }
    },
    enemy_6: {
        id: "enemy_6",
        name: "Lei Heng",
        maxHP: 244,
        atk: 24,
        def: 0,
        status: {Bleed:0,Shock:0,Stun:0,DefenseUp:0,Burn:0},
        skills: {
            s1:{name: "Double Slash - Blast [爆]", damage: 2, effects:[{type: "Burn", value: 1}]},
            s2:{name: "Triple Slash - Blast [爆]", damage: 3, effects:[{type: "Burn", value: 2}]},
            s3:{name: "Savage Tigerslayer's Perfected Flurry of Blades [超絕猛虎殺擊亂斬]", damage: 6, effects:[{type: "Burn", value: 3}]},
        }
    },
};

/* ============================================================
   RUNTIME VARIABLES
============================================================ */
let player = null;
let enemy = null;

let hand = [];
const MAX_HAND = 5;

/* ============================================================
   STATUS SYSTEM
============================================================ */

function ensureStatus(e) {
    if (!e.status) e.status = {};
}

function getStatus(e, type) {
    ensureStatus(e);
    return e.status[type] || 0;
}

function clampStatus(e) {
    if (e.status.Shock > 20) e.status.Shock = 20;
    if (e.status.DefenseUp > 10) e.status.DefenseUp = 10;
}

function addStatus(e, type, value = 1) {
    ensureStatus(e);
    e.status[type] = (e.status[type] || 0) + value;
    clampStatus(e);
    log(`${e.name} gains ${value} ${type}.`);
}

function removeStatus(e, type) {
    ensureStatus(e);
    e.status[type] = 0;
}
//------Burn-----//
function applyBurn(entity) {
    let stacks = getStatus(entity, "Burn");
    if (stacks <= 0) return;

    let dmg = stacks * 5;
    entity.currentHP -= dmg;
    if (entity.currentHP < 0) entity.currentHP = 0;

    log(`${entity.name} suffers ${dmg} Burn damage!`);
    entity.status.Burn = 0; // Remove all burn

    updateHPBars();
}
/* ============================================================
   BLEED (Limbus-like)
============================================================ */
function applyBleed(e) {
    let stacks = getStatus(e, "Bleed");
    if (stacks <= 0) return;

    let hits = Math.floor(stacks / 2);
    if (hits < 1) hits = 1;
    if (hits > 5) hits = 5;

    for (let i = 0; i < hits; i++) {
        e.currentHP -= stacks;
        if (e.currentHP < 0) e.currentHP = 0;

        log(`${e.name} suffers ${stacks} Bleed damage.`);
        stacks--;

        if (stacks <= 0) break;
    }

    e.status.Bleed = stacks;
    updateHPBars();
}

/* ============================================================
   DAMAGE FORMULA
============================================================ */
function effectiveDEF(target) {
    return target.def + getStatus(target, "DefenseUp");
}

function shockMultiplier(target) {
    const stacks = getStatus(target, "Shock");
    const bonus = Math.min(stacks * 0.5, 10);
    return 1 + bonus / 100;
}

function inDefenseStance(unit) {
    return getStatus(unit, "DefenseUp") >= (unit.passive?.defenseStanceThreshold || 999);
}

function calculateDamage(attacker, base, target) {
    const atkUp = getStatus(attacker, "ATKUp");
    const atkValue = attacker.atk + atkUp;

    let dmg = Math.floor(base + atkValue * 0.2 - effectiveDEF(target) * 0.3);
    if (dmg < 0) dmg = 0;

    if (inDefenseStance(attacker)) dmg = Math.floor(dmg * attacker.passive.defenseDealMult);
    if (inDefenseStance(target)) dmg = Math.floor(dmg * target.passive.defenseTakenMult);

    dmg = Math.floor(dmg * shockMultiplier(target));

    return Math.max(0, dmg);
}

/* ============================================================
   CHARACTER SELECTION
============================================================ */
qAll(".unit-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        const id = btn.dataset.id;
        player = JSON.parse(JSON.stringify(characterData[id]));
        player.currentHP = player.maxHP;

        qAll(".unit-btn").forEach(b => b.textContent = "Select This Unit");
        btn.textContent = "Unit Selected";

        log(`${player.name} selected.`);
    });
});

/* ============================================================
   START BATTLE
============================================================ */
$("start-btn").addEventListener("click", () => {
    if (!player) return alert("Select a character first!");

    enemy = JSON.parse(JSON.stringify(randomEnemy()));
    enemy.currentHP = enemy.maxHP;

    $("prep").style.display = "none";
    $("battle").style.display = "block";

    $("player-name").textContent = player.name;
    $("enemy-name").textContent = enemy.name;

    hand = [];
    for (let i = 0; i < 3; i++) hand.push(drawSkill(player));
    renderHand();

    updateHPBars();
    log(`Encounter ${enemy.name}`);
});

function randomEnemy() {
    const keys = Object.keys(enemies);
    return enemies[keys[Math.floor(Math.random() * keys.length)]];
}

/* ============================================================
   SKILL CARD SYSTEM
============================================================ */
function drawSkill(ch) {
    const r = Math.random() * 100;

    // Sonelia passive: Take It Back! -> replace Guard with Counter if enemy has 2+ Bleed
    if (ch.id === "char_1" && enemy && getStatus(enemy, "Bleed") >= 2) {
        return {
            id: "counter_mode",
            name: "Counter",
            damage: Math.floor(ch.atk * ch.passive.counterDamageScale),
            effects: [{ type: "Bleed", value: ch.passive.counterBleed }]
        };
    }

    if (r < 40) return ch.skills.skill1;
    if (r < 65) return ch.skills.skill2;
    return ch.skills.skill3;
}

function renderHand() {
    const area = $("hand");
    area.innerHTML = "";
    hand.forEach((card, i) => {
        const btn = document.createElement("button");
        btn.className = "skill-card";
        btn.textContent = card.name;
        btn.onclick = () => playCard(i);
        area.appendChild(btn);
    });
}

function playCard(i) {
    useSkill(hand[i]);
    hand.splice(i, 1);

    if (hand.length < MAX_HAND) hand.push(drawSkill(player));
    renderHand();

    if (checkEnd()) return;

    setTimeout(enemyTurn, 300);
}

/* ============================================================
   USE SKILL
============================================================ */
function useSkill(skill) {
    if (!skill) return;

    // Gilbert alt skill
    if (player.id === "char_2" && skill.id === "skill2" && getStatus(enemy, "Shock") >= 10) {
        skill = player.skills.skill2_alt;
    }

    // Sonelia Guard special
    if (player.id === "char_1" && skill.id === "skill3") {
        activateGuard_Sonelia();
        updateHPBars();
        return;
    }

    // Gilbert: Ward requires 3+ Shock
    if (player.id === "char_2" && skill.id === "skill2" && getStatus(enemy, "Shock") < 3) {
        log("Ward requires 3+ Shock!");
        return;
    }

    let dmg = calculateDamage(player, skill.damage, enemy);

    // Apply instant effects
    if (skill.effects) {
        skill.effects.forEach(e => {
            if (e.type === "Shock") addStatus(enemy, "Shock", e.value);
        });
    }

    // ConsumeShock skills (Ward / Crushader)
    if (skill.effects) {
        skill.effects.forEach(e => {
            if (e.type === "ConsumeShockToDefense") {
                const s = getStatus(enemy, "Shock");
                const extra = Math.floor(s * 0.5);
                dmg += extra;
                removeStatus(enemy, "Shock");
                addStatus(player, "DefenseUp", s);
            }
            if (e.type === "ConsumeShockToDamage") {
                const s = getStatus(enemy, "Shock");
                const extra = Math.floor(s * 1.5);
                dmg += extra;
                removeStatus(enemy, "Shock");
            }
        });
    }

    // Apply damage
    enemy.currentHP = Math.max(0, enemy.currentHP - dmg);
    log(`${player.name} uses ${skill.name}, dealing ${dmg} damage.`);
    updateHPBars();

    // Effects: Bleed etc.
    if (skill.effects) {
        skill.effects.forEach(e => {
            if (e.type === "Bleed") addStatus(enemy, "Bleed", e.value);
            if (e.type === "triggerBleedThenRemove") {
                applyBleed(enemy);
                removeStatus(enemy, "Bleed");
            }
        });
    }

    /* ====================================================
       SONELIA PASSIVES
    ==================================================== */

    // Fragile Wound
    if (player.id === "char_1") {
        const bleed = getStatus(enemy, "Bleed");
        if (bleed > 0) {
            let chance = player.passive.fragileBase + bleed * player.passive.fragilePerBleed;
            if (chance > player.passive.fragileMax) chance = player.passive.fragileMax;
            if (Math.random() * 100 < chance) {
                addStatus(enemy, "Stun", 1);
                log("Fragile Wound: Enemy stunned!");
            }
        }
    }

    // Open Wound
    if (player.id === "char_1") {
        if (getStatus(enemy, "Stun") > 0) {
            addStatus(enemy, "Bleed", 1);
            if (getStatus(enemy, "Bleed") >= 5) addStatus(enemy, "Bleed", 1);
        }
    }

    // Overtaken (after skill2)
    if (player.id === "char_1" && skill.id === "skill2") {
        addStatus(player, "ATKUp", player.passive.overtakenATKUp);
        if (enemy.currentHP <= enemy.maxHP * 0.5) addStatus(enemy, "Bleed", 1);
    }

    // Gilbert Terror Shock
    if (player.id === "char_2") {
        const s = getStatus(enemy, "Shock");
        if (s >= 3) {
            let chance = (s >= 10) ? player.passive.terrorShockHigh : player.passive.terrorShockLow;
            if (Math.random() < chance) {
                addStatus(enemy, "Stun", 1);
                log(`Terror Shock: ${enemy.name} stunned!`);
            }
        }
    }

    applyBleed(player);
    updateHPBars();
}

/* ============================================================
   SONELIA GUARD / COUNTER
============================================================ */
function activateGuard_Sonelia() {
    const missing = player.maxHP - player.currentHP;
    const shieldGain = Math.floor(missing * player.passive.guardShieldPercent);
    player.shield += shieldGain;

    log(`${player.name} uses Guard, gaining ${shieldGain} Shield.`);

    if (getStatus(enemy, "Bleed") >= 2) {
        player.counterReady = true;
        log("Counter activated!");
    }
}

/* ============================================================
   ENEMY TURN
============================================================ */
function enemyTurn() {
    if (checkEnd()) return;

    // Stunned
    if (getStatus(enemy, "Stun") > 0) {
        log(`${enemy.name} is stunned and skips the turn!`);
        removeStatus(enemy, "Stun");
        return;
    }
    if (enemy.currentHP <= 0) return;

    const keys = Object.keys(enemy.skills);
    const skill = enemy.skills[keys[Math.floor(Math.random() * keys.length)]];
    // Shield absorbs first
    if (player.shield > 0) {
        const absorbed = Math.min(player.shield, dmg);
        player.shield -= absorbed;
        dmg -= absorbed;
        log(`Shield absorbed ${absorbed} damage.`);
    }
    // Damage calculation
    let damage = Math.floor(skill.damage + enemy.atk * 0.2 - player.def * 0.3);
    if (damage < 0) damage = 0;

    player.currentHP -= damage;
    if (player.currentHP < 0) player.currentHP = 0;

    log(`${enemy.name} uses ${skill.name}, dealing ${damage} damage.`);

    // Apply enemy skill effects
    if (skill.effects) {
        skill.effects.forEach(e => {
            if (e.type === "Shock") addStatus(player, "Shock", e.value);
            if (e.type === "Bleed") addStatus(player, "Bleed", e.value);
            if (e.type === "Burn") addStatus(player, "Burn", e.value);
            if (e.type === "Stun") addStatus(player, "Stun", e.value);
        });
    }

    // Apply DOT effects
    applyBleed(enemy);   // Enemy suffers its own bleed
    applyBurn(player);   // Player suffers Burn at end of enemy turn

    updateHPBars();

    // Check defeat
    if (player.currentHP <= 0) {
        log(`${player.name} has fallen in battle...`);
    }
}

/* ============================================================
   END CHECK
============================================================ */
function checkEnd() {
    if (enemy.currentHP <= 0) {
        $("battle").style.display = "none";
        $("victory-screen").style.display = "flex";
        return true;
    }
    if (player.currentHP <= 0) {
        $("battle").style.display = "none";
        $("defeat-screen").style.display = "flex";
        return true;
    }
    return false;
}

$("return-btn-victory").addEventListener("click", () => location.reload());
$("return-btn-defeat").addEventListener("click", () => location.reload());

/* ============================================================
   HP BAR
============================================================ */
function updateHPBars() {
    $("player-hp-fill").style.width =
        (player.currentHP / player.maxHP * 100) + "%";

    $("player-hp-text").textContent =
        `${player.currentHP} / ${player.maxHP}`;

    $("enemy-hp-fill").style.width =
        (enemy.currentHP / enemy.maxHP * 100) + "%";

    $("enemy-hp-text").textContent =
        `${enemy.currentHP} / ${enemy.maxHP}`;
}
</script>
</body>
</html>
